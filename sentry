#!/bin/bash -e

RUNDIR=/run/sentry

GPIO_UNLOCK=30
GPIO_LOCK=31

GPIO_UNLOCKED=60
GPIO_LOCKED=48
GPIO_CLOSED=51

###

gpio=/sys/class/gpio

export() {
  id=$1; direction=$2; name=$3
  echo $id > $gpio/export
  echo $direction > $gpio/gpio$id/direction
  mkdir -p $RUNDIR
  chown sentry:sentry $gpio/gpio$id/value
  chmod g+w $gpio/gpio$id/value
  ln -sf $gpio/gpio$id/value $RUNDIR/$name
}

case $1 in
init)
  export $GPIO_UNLOCK low unlock
  echo "initialized" 1>&2
  ;;
uninit)
  rm $RUNDIR/*
  echo $GPIO_UNLOCK > $gpio/unexport
  echo "uninitialized" 1>&2
  ;;
unlock)
  reset() {
    echo 0 > $RUNDIR/unlock
    echo "reset unlock signal" 1>&2
  }
  trap reset EXIT
  echo 1 > $RUNDIR/unlock
  echo "set unlock signal" 1>&2
  sleep 1
  ;;
*)
  echo "usage: $(basename $0) <command>" 1>&2
  echo "  init    Initialize sentry functionality (must be root)" 1>&2
  echo "  uninit  Uninitialize sentry functionality (must be root)" 1>&2
  echo "  unlock  Unlock the deadbolt" 1>&2
  exit 2;
  ;;
esac
