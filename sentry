#!/bin/bash -e

RUNDIR=/run/sentry
GPIO_UNLOCK=30

###

gpio=/sys/class/gpio
gpio_unlock=$gpio/gpio$GPIO_UNLOCK

case $1 in
init)
  echo $GPIO_UNLOCK > $gpio/export
  echo low > $gpio_unlock/direction
  mkdir -p $RUNDIR
  chown sentry:sentry $gpio_unlock/value
  chmod g+w $gpio_unlock/value
  ln -sf $gpio_unlock/value $RUNDIR/unlock
  echo "sentry initialized" 1>&2
  ;;
uninit)
  rm $RUNDIR/*
  echo $GPIO_UNLOCK > $gpio/unexport
  echo "sentry uninitialized" 1>&2
  ;;
unlock)
  reset() {
    echo "done" 1>&2
    echo 0 > $RUNDIR/unlock
  }
  trap reset EXIT
  echo -n "sending unlock signal... " 1>&2
  echo 1 > $RUNDIR/unlock
  sleep 1
  ;;
*)
  echo "usage: $(basename $0) <command>" 1>&2
  echo "  init    Initialize sentry functionality (must be root)" 1>&2
  echo "  uninit  Uninitialize sentry functionality (must be root)" 1>&2
  echo "  unlock  Unlock the deadbolt" 1>&2
  exit 2;
  ;;
esac
